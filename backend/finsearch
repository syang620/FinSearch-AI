#!/usr/bin/env python3
"""
FinSearch - Simple CLI for financial Q&A
Usage: ./finsearch "What was Apple's revenue last quarter?"
"""

import sys
import os
sys.path.insert(0, os.path.dirname(os.path.abspath(__file__)))

from app.services.llm.ollama_service import get_ollama_service
from app.services.rag.retriever import rag_retriever

def main():
    if len(sys.argv) < 2:
        print("FinSearch CLI - Financial Q&A System")
        print("Usage: ./finsearch \"your question\"")
        print("\nExamples:")
        print("  ./finsearch \"What was Apple's revenue?\"")
        print("  ./finsearch \"Explain EBITDA\"")
        print("\nFor interactive mode, use: python cli_chat.py")
        sys.exit(1)

    query = ' '.join(sys.argv[1:])

    try:
        # Initialize Ollama
        ollama = get_ollama_service()

        # Try to get context
        context = None
        try:
            results = rag_retriever.retrieve_context(query=query, n_results=3)
            if results and 'contexts' in results:
                contexts = results['contexts'][:3]
                context = "\n\n".join([ctx['text'] for ctx in contexts])
        except:
            pass

        # Get response
        response = ollama.chat(
            query=query,
            context=context,
            max_new_tokens=512
        )

        print("\n" + response + "\n")

        # Show sources if available
        if results and 'contexts' in results and contexts:
            print("Sources:")
            for i, ctx in enumerate(contexts, 1):
                metadata = ctx.get('metadata', {})
                # Try source_uri first, then filename, then source
                source = metadata.get('source_uri') or metadata.get('filename') or metadata.get('source', 'Unknown')
                # Extract just the filename from path if it's a full path
                if '/' in source:
                    source = source.split('/')[-1]
                print(f"  [{i}] {source}")

    except Exception as e:
        print(f"Error: {e}")
        print("Make sure Ollama is running: ollama serve")
        sys.exit(1)

if __name__ == "__main__":
    main()